<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>å¯»å®æ¸¸æˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); color:#fff; min-height:100vh; padding:20px; }
        .container { max-width:1200px; margin:0 auto; padding:20px; }
        header { text-align:center; margin-bottom:40px; padding:20px; background:rgba(0,0,0,0.3); border-radius:15px; }
        h1 { font-size:2.2rem; }
        .nav-tabs { display:flex; justify-content:center; margin-bottom:20px; gap:10px; }
        .nav-tab { padding:10px 18px; background: rgba(255,255,255,0.08); border-radius:8px; cursor:pointer; }
        .nav-tab.active { background: linear-gradient(90deg,#ff8a00,#e52e71); transform:translateY(-3px); }
        .auth-page { display:flex; justify-content:center; align-items:center; min-height:50vh; }
        .auth-container { background: rgba(0,0,0,0.4); border-radius:15px; padding:30px; width:100%; max-width:480px; }
        label { font-weight:600; }
        input, select { padding:10px; border-radius:8px; border:none; background:rgba(255,255,255,0.08); color:#fff; }
        button { background: linear-gradient(90deg,#ff8a00,#e52e71); color:#fff; border:none; padding:10px 18px; border-radius:999px; cursor:pointer; }
        button.secondary { background: rgba(255,255,255,0.12); }
        .user-list { margin-top:16px; }
        .user-item { display:flex; justify-content:space-between; align-items:center; padding:12px; background: rgba(255,255,255,0.04); border-radius:8px; margin-bottom:8px; cursor:pointer; }
        .panorama { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:14px; margin-bottom:20px; }
        .location { background: rgba(0,0,0,0.4); border-radius:12px; padding:18px; text-align:center; cursor:pointer; }
        .location-icon { font-size:3rem; margin-bottom:8px; }
        .location-page { background: rgba(0,0,0,0.45); border-radius:12px; padding:18px; }
        .progress-bar { height:18px; background: rgba(255,255,255,0.12); border-radius:10px; overflow:hidden; }
        .progress { height:100%; background: linear-gradient(90deg,#ff8a00,#e52e71); width:0%; transition: width .4s ease; }
        .log-container { margin-top:12px; max-height:160px; overflow:auto; background: rgba(0,0,0,0.25); padding:10px; border-radius:8px; }
        .user-profile, .ranking-page { background: rgba(0,0,0,0.45); border-radius:12px; padding:18px; }
        .ranking-table { width:100%; border-collapse:collapse; margin-top:12px; }
        .ranking-table th, .ranking-table td { padding:8px 10px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.06); }
        .rank-badge { display:inline-block; width:28px; height:28px; border-radius:50%; background:linear-gradient(90deg,#ff8a00,#e52e71); text-align:center; line-height:28px; font-weight:700; }
        .current-user-highlight { background: rgba(255,215,0,0.08); }
        .music-control { position: fixed; bottom:20px; right:20px; background: rgba(0,0,0,0.6); border-radius:50%; width:50px; height:50px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
        .back-btn { background: rgba(0,0,0,0.5); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; margin-bottom:12px; }
        @media (max-width:768px) { .panorama{grid-template-columns:1fr;} }
    </style>
</head>
<body>
<div id="app"></div>

<!-- ä¸ºä¸åŒé¡µé¢è®¾ç½®ä¸åŒçš„èƒŒæ™¯éŸ³ä¹ -->
<audio id="homeMusic" loop>
  <source src="home-music.mp3" type="audio/mpeg">
  æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ ã€‚
</audio>

<audio id="libraryMusic" loop>
  <source src="library-music.mp3" type="audio/mpeg">
  æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ ã€‚
</audio>

<audio id="templeMusic" loop>
  <source src="temple-music.mp3" type="audio/mpeg">
  æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ ã€‚
</audio>

<audio id="forestMusic" loop>
  <source src="forest-music.mp3" type="audio/mpeg">
  æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ ã€‚
</audio>

<audio id="caveMusic" loop>
  <source src="cave-music.mp3" type="audio/mpeg">
  æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ ã€‚
</audio>

<script>
// ------------- å…¨å±€å•ä¾‹æ¸¸æˆçŠ¶æ€
const { createApp, reactive, ref, computed, onMounted, watch } = Vue;

const LOCAL_KEY = 'treasureGameState_v2';

function createGameStateSingleton() {
    const state = reactive({
        currentPage: 'login',
        musicEnabled: false,
        currentUser: null,
        users: [],
        library: { progress: 0, currentStep: 0, completed: false, logs: [] },
        temple: { progress: 0, currentStep: 0, completed: false, logs: [] },
        forest: { progress: 0, currentStep: 0, completed: false, logs: [] },
        cave: { progress: 0, currentStep: 0, completed: false, logs: [] }
    });

    // ç§»é™¤ä¿å­˜çŠ¶æ€åŠŸèƒ½
    const saveState = () => {
        // ä¸ä¿å­˜ä»»ä½•çŠ¶æ€
        return;
    };

    // ç§»é™¤åŠ è½½çŠ¶æ€åŠŸèƒ½
    const loadState = () => {
        // ä¸åŠ è½½ä»»ä½•çŠ¶æ€ï¼Œæ¯æ¬¡éƒ½ä»åˆå§‹çŠ¶æ€å¼€å§‹
        return;
    };

    const registerUser = (userData) => {
        const newUser = {
            id: Date.now().toString() + Math.floor(Math.random()*1000),
            name: userData.name || 'æ¸¸å®¢' + Math.floor(Math.random()*1000),
            level: userData.level || 'æ–°æ‰‹',
            joinDate: new Date().toISOString(),
            lastActive: new Date().toISOString(),
            progress: {
                library: { progress: 0, currentStep: 0, completed: false },
                temple: { progress: 0, currentStep: 0, completed: false },
                forest: { progress: 0, currentStep: 0, completed: false },
                cave: { progress: 0, currentStep: 0, completed: false }
            },
            totalScore: 0
        };
        state.users.push(newUser);
        return newUser;
    };

    const loginUser = (userId) => {
        const user = state.users.find(u => u.id === userId);
        if (!user) return false;
        state.currentUser = user;
        // åŒæ­¥æ¸¸æˆçŠ¶æ€åˆ°å…¨å±€ stateï¼ˆåŠ è½½ç”¨æˆ·è¿›åº¦ï¼‰
        Object.keys(user.progress).forEach(loc => {
            state[loc] = Object.assign({}, state[loc], user.progress[loc]);
            if (!state[loc].logs) state[loc].logs = [];
        });
        user.lastActive = new Date().toISOString();
        state.currentPage = 'panorama'; // è®¾ç½®å½“å‰é¡µé¢ä¸ºå…¨æ™¯
        return true;
    };

    const logoutUser = () => {
        state.currentUser = null;
        state.currentPage = 'login';
    };

    const updateLocationProgress = (location, progress, currentStep) => {
        if (!state[location]) return;
        state[location].progress = progress;
        state[location].currentStep = currentStep;
        // æ›´æ–°å½“å‰ç”¨æˆ·å‰¯æœ¬
        if (state.currentUser) {
            const u = state.users.find(x => x.id === state.currentUser.id);
            if (u) {
                u.progress[location] = {
                    progress: state[location].progress,
                    currentStep: state[location].currentStep,
                    completed: !!state[location].completed
                };
                u.lastActive = new Date().toISOString();
                // è®¡ç®—æ€»åˆ†ï¼šæ¯ä¸ªå®Œæˆçš„åœ°ç‚¹è®¡100åˆ†ï¼Œå¦åˆ™å–è¿›åº¦
                u.totalScore = Object.values(u.progress).reduce((sum, loc) => sum + (loc.completed ? 100 : (loc.progress || 0)), 0);
            }
        }
    };

    const completeLocation = (location) => {
        if (!state[location]) return;
        state[location].completed = true;
        state[location].progress = 100;
        if (state.currentUser) {
            const u = state.users.find(x => x.id === state.currentUser.id);
            if (u) {
                u.progress[location] = { progress: 100, currentStep: state[location].currentStep, completed: true };
                u.lastActive = new Date().toISOString();
                u.totalScore = Object.values(u.progress).reduce((sum, loc) => sum + (loc.completed ? 100 : (loc.progress || 0)), 0);
            }
        }
    };

    const addLogToLocation = (location, message, type='') => {
        if (!state[location]) return;
        const entry = { message, type, timestamp: new Date().toLocaleTimeString() };
        if (!state[location].logs) state[location].logs = [];
        state[location].logs.push(entry);

        if (state.currentUser) {
            const u = state.users.find(x => x.id === state.currentUser.id);
            if (u && !u.progress[location].logs) u.progress[location].logs = [];
            if (u && u.progress[location].logs) u.progress[location].logs.push(entry);
        }
    };

    const resetLocation = (location) => {
        if (!state[location]) return;
        state[location] = { progress: 0, currentStep: 0, completed: false, logs: [] };
        if (state.currentUser) {
            const u = state.users.find(x => x.id === state.currentUser.id);
            if (u) u.progress[location] = { progress: 0, currentStep: 0, completed: false };
        }
    };

    const setCurrentPage = (page) => {
        state.currentPage = page;
    };

    const toggleMusic = () => {
        state.musicEnabled = !state.musicEnabled;
        return state.musicEnabled;
    };

    const getRankings = computed(() => {
        const sorted = [...state.users].sort((a,b) => (b.totalScore||0)-(a.totalScore||0));
        return sorted.map((u, idx) => ({ ...u, rank: idx+1 }));
    });

    return {
        state,
        saveState,
        loadState,
        registerUser,
        loginUser,
        logoutUser,
        updateLocationProgress,
        completeLocation,
        addLogToLocation,
        resetLocation,
        setCurrentPage,
        toggleMusic,
        getRankings
    };
}

const gameState = createGameStateSingleton();
// ä¸å†åŠ è½½ä»»ä½•ä¿å­˜çš„çŠ¶æ€

// ---------------- åœ°ç‚¹æ¢ç´¢é€»è¾‘ ----------------
function createLocationExplorer(locationName) {
    const steps = 3;
    const currentStep = ref(gameState.state[locationName].currentStep || 0);
    const isRunning = ref(false);
    const logEntries = ref(gameState.state[locationName].logs ? [...gameState.state[locationName].logs] : []);

    const loadProgress = () => {
        currentStep.value = gameState.state[locationName].currentStep || 0;
        logEntries.value = gameState.state[locationName].logs ? [...gameState.state[locationName].logs] : [];
    };

    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    const performStep1 = async () => {
        const map = {
            library: "åœ¨å¤è€çš„ä¹¦æ¶ä¸Šæ‰¾åˆ°äº†ä¸€æœ¬ç¥ç§˜çš„ä¹¦ç±...",
            temple: "æˆåŠŸè¿›å…¥ç¥åº™ï¼Œå‘ç°äº†ä¸€ä¸ªå¤è€çš„çŸ³ç¢‘...",
            forest: "ç©¿è¶Šæµ“é›¾ï¼Œåœ¨æ£®æ—æ·±å¤„å‘ç°äº†ä¸€æ¡éšè—çš„å°å¾„...",
            cave: "æ‰¾åˆ°äº†æ´ç©´å…¥å£ï¼Œç‚¹ç‡ƒç«æŠŠå‡†å¤‡è¿›å…¥..."
        };
        return map[locationName] || "è¿›è¡Œäº†æ¢ç´¢ç¬¬ä¸€æ­¥";
    };
    const performStep2 = async () => {
        const map = {
            library: "ç ´è¯‘äº†ä¹¦ç±ä¸­çš„å¤è€æ–‡å­—ï¼Œå‘ç°äº†å®è—çº¿ç´¢...",
            temple: "è§£å¼€äº†çŸ³ç¢‘ä¸Šçš„è°œé¢˜ï¼Œè·å¾—äº†ç¥åº™åœ°å›¾...",
            forest: "æ²¿ç€å°å¾„å‰è¿›ï¼Œé¿å¼€å±é™©åŒºåŸŸï¼Œå‘ç°äº†ä¸€ä¸ªç¥ç§˜çš„ç¬¦å·...",
            cave: "æ·±å…¥æ´ç©´ï¼Œåœ¨è¿·å®«èˆ¬çš„é€šé“ä¸­æ‰¾åˆ°äº†æ­£ç¡®è·¯å¾„..."
        };
        return map[locationName] || "è¿›è¡Œäº†æ¢ç´¢ç¬¬äºŒæ­¥";
    };
    const performStep3 = async () => {
        const map = {
            library: "æ‰¾åˆ°äº†éšè—çš„å®è—åœ°å›¾!åœ°å›¾æŒ‡å‘è¿·é›¾æ£®æ—...",
            temple: "è·å¾—äº†ç¥åº™æ·±å¤„çš„ç¥ç§˜é’¥åŒ™!é’¥åŒ™å¯ä»¥æ‰“å¼€æŸä¸ªå®ç®±...",
            forest: "å‘ç°äº†æŒ‡å‘éšè—æ´ç©´çš„å¤è€æ ‡è®°!",
            cave: "åœ¨æ´ç©´æ·±å¤„å‘ç°äº†ä¼ è¯´ä¸­çš„å®è—å®ç®±!"
        };
        return map[locationName] || "å®Œæˆäº†æ¢ç´¢ç¬¬ä¸‰æ­¥";
    };

    const addLog = (message, type='') => {
        const ts = new Date().toLocaleTimeString();
        const entry = { message, type, timestamp: ts };
        logEntries.value.push(entry);
        if (!gameState.state[locationName].logs) gameState.state[locationName].logs = [];
        gameState.state[locationName].logs.push(entry);
        gameState.addLogToLocation(locationName, message, type);
    };

    const updateProgress = (step, message) => {
        currentStep.value = step;
        const percent = (step / steps) * 100;
        gameState.updateLocationProgress(locationName, percent, step);
        addLog(message);
    };

    const startExploration = async () => {
        if (isRunning.value || gameState.state[locationName].completed) return;
        isRunning.value = true;
        try {
            updateProgress(1, `å¼€å§‹æ¢ç´¢${displayName()}...`);
            await delay(1200);
            const r1 = await performStep1();
            addLog(r1, 'success');

            updateProgress(2, `ç»§ç»­æ¢ç´¢${displayName()}...`);
            await delay(1400);
            const r2 = await performStep2();
            addLog(r2, 'success');

            updateProgress(3, `å®Œæˆ${displayName()}æ¢ç´¢...`);
            await delay(1500);
            const r3 = await performStep3();
            addLog(r3, 'success');

            gameState.completeLocation(locationName);
            addLog(`åœ°ç‚¹ ${displayName()} å·²å®Œæˆï¼`, 'success');
        } catch (e) {
            addLog(`æ¢ç´¢å¤±è´¥: ${e}`, 'error');
        } finally {
            isRunning.value = false;
        }
    };

    const resetExploration = () => {
        currentStep.value = 0;
        logEntries.value = [];
        gameState.resetLocation(locationName);
    };

    const displayName = () => {
        const names = { library:'å¤è€å›¾ä¹¦é¦†', temple:'ç¥ç§˜ç¥åº™', forest:'è¿·é›¾æ£®æ—', cave:'éšè—æ´ç©´' };
        return names[locationName] || locationName;
    };

    const progressPercent = computed(() => (currentStep.value / steps) * 100);
    const isCompleted = computed(() => !!gameState.state[locationName].completed);
    const stepStatus = computed(() => {
        const s = {};
        for (let i=1;i<=steps;i++) s[i] = { active: i===currentStep.value, completed: i<currentStep.value };
        return s;
    });

    loadProgress();

    return { currentStep, isRunning, logEntries, startExploration, resetExploration, progressPercent, isCompleted, stepStatus, displayName };
}

// ---------------- ç»„ä»¶ ----------------
const LoginPage = {
    template: `
        <div class="auth-page">
            <div class="auth-container">
                <h2 style="text-align:center;margin-bottom:12px;">ç™»å½•å¯»å®æ¸¸æˆ</h2>

                <div v-if="gameState.state.users.length>0" class="user-list">
                    <div v-for="user in gameState.state.users" :key="user.id" class="user-item" @click="loginAs(user.id)">
                        <div>
                            <div style="font-weight:700">{{ user.name }}</div>
                            <div style="opacity:0.8;font-size:0.9rem;">ç­‰çº§: {{ user.level }}</div>
                        </div>
                        <div style="font-weight:700">{{ user.totalScore || 0 }}åˆ†</div>
                    </div>
                </div>
                <div v-else style="text-align:center;padding:12px;">æš‚æ— ç”¨æˆ·ï¼Œå…ˆæ³¨å†Œä¸€ä¸ªå§</div>

                <div style="margin-top:14px;">
                    <button @click="switchToRegister" class="secondary">æ³¨å†Œæ–°ç”¨æˆ·</button>
                </div>
            </div>
        </div>
    `,
    setup(props, { emit }) {
        const loginAs = (id) => {
            if (gameState.loginUser(id)) {
                // ç™»å½•æˆåŠŸï¼Œä¸éœ€è¦emitï¼Œå› ä¸ºçŠ¶æ€å·²ç»æ›´æ–°
            } else {
                alert('ç™»å½•å¤±è´¥');
            }
        };
        
        const switchToRegister = () => {
            emit('switch-to-register');
        };
        
        return {
            gameState,
            loginAs,
            switchToRegister
        };
    }
};

const RegisterPage = {
    template: `
        <div class="auth-page">
            <div class="auth-container">
                <h2 style="text-align:center;margin-bottom:12px;">æ³¨å†Œæ–°ç”¨æˆ·</h2>
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <div><label>ç”¨æˆ·å</label><input v-model="name" placeholder="è¾“å…¥ç”¨æˆ·å"/></div>
                    <div><label>é€‰æ‹©ç­‰çº§</label><select v-model="level"><option>æ–°æ‰‹</option><option>å†’é™©è€…</option><option>ä¸“å®¶</option></select></div>
                    <div style="display:flex;gap:8px;margin-top:8px;">
                        <button @click="register">æ³¨å†Œå¹¶ç™»å½•</button>
                        <button class="secondary" @click="switchToLogin">è¿”å›ç™»å½•</button>
                    </div>
                </div>
            </div>
        </div>
    `,
    setup(props, { emit }) {
        const name = ref('');
        const level = ref('æ–°æ‰‹');
        const register = () => {
            const trimmed = (name.value || '').trim();
            if (!trimmed) { alert('è¯·è¾“å…¥ç”¨æˆ·å'); return; }
            const u = gameState.registerUser({ name: trimmed, level: level.value });
            if (gameState.loginUser(u.id)) {
                // æ³¨å†Œå¹¶ç™»å½•æˆåŠŸï¼Œä¸éœ€è¦emitï¼Œå› ä¸ºçŠ¶æ€å·²ç»æ›´æ–°
            }
        };
        
        const switchToLogin = () => {
            emit('switch-to-login');
        };
        
        return { name, level, register, switchToLogin };
    }
};

const LocationCard = {
    props: ['location'],
    template: `
        <div class="location" @click="$emit('select', location.id)">
            <div class="location-icon">{{ location.icon }}</div>
            <div style="font-weight:700">{{ location.name }}</div>
            <div style="opacity:0.85;margin-top:6px;">{{ location.description }}</div>
        </div>
    `
};

const PanoramaPage = {
    template: `
        <div>
            <h2 style="text-align:center;margin-bottom:12px;">é€‰æ‹©æ¢ç´¢åœ°ç‚¹</h2>
            <div class="panorama">
                <LocationCard v-for="loc in locations" :key="loc.id" :location="loc" @select="$emit('select-location', $event)" />
            </div>
        </div>
    `,
    setup() {
        const locations = ref([
            { id:'library', name:'å¤è€å›¾ä¹¦é¦†', icon:'ğŸ“š', description:'å¯»æ‰¾å¤è€åœ°å›¾å’Œçº¿ç´¢' },
            { id:'temple', name:'ç¥ç§˜ç¥åº™', icon:'ğŸ›ï¸', description:'è§£å¼€å¤è€è°œé¢˜' },
            { id:'forest', name:'è¿·é›¾æ£®æ—', icon:'ğŸŒ²', description:'ç©¿è¶Šå±é™©åœ°å¸¦' },
            { id:'cave', name:'éšè—æ´ç©´', icon:'ğŸ•³ï¸', description:'å¯»æ‰¾æœ€ç»ˆå®è—' },
        ]);
        return { locations };
    },
    components: { LocationCard }
};

const ProgressBar = {
    props: ['progress'],
    template: `
        <div style="margin:12px 0;">
            <div class="progress-bar"><div class="progress" :style="{width: progress + '%'}"></div></div>
            <div style="text-align:center;margin-top:6px;">{{ Math.round(progress) }}%</div>
        </div>
    `
};

const StepItem = {
    props:['step','index','status'],
    template:`
        <div :class="['step', { 'active': status.active, 'completed': status.completed }]" style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;">
            <div style="width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;font-weight:700">{{ index }}</div>
            <div><div style="font-weight:700">{{ step.title }}</div><div style="opacity:0.8;font-size:0.9rem;">{{ step.description }}</div></div>
        </div>
    `
};

const ExplorationLog = {
    props:['entries'],
    template:`
        <div class="log-container">
            <div style="font-weight:700;margin-bottom:8px;">æ¢ç´¢æ—¥å¿—</div>
            <div v-for="(e,idx) in entries" :key="idx" style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.03);">
                <strong>[{{ e.timestamp }}]</strong> {{ e.message }}
            </div>
        </div>
    `
};

const LocationPage = {
    props: ['locationId'],
    template: `
        <div>
            <button class="back-btn" @click="$emit('back')">â† è¿”å›å…¨æ™¯</button>
            <div class="location-page">
                <div style="text-align:center;">
                    <div style="font-size:2.4rem;">{{ location.icon }}</div>
                    <h2 style="margin:6px 0;">{{ location.name }}</h2>
                    <p style="opacity:0.9">{{ location.description }}</p>
                </div>

                <ProgressBar :progress="progressPercent" />

                <div style="display:flex;flex-direction:column;gap:10px;margin-top:8px;">
                    <StepItem v-for="(step,idx) in steps" :key="idx" :step="step" :index="idx+1" :status="stepStatus[idx+1]" />
                </div>

                <div style="text-align:center;margin-top:14px;">
                    <button @click="startExploration" :disabled="isRunning || isCompleted">{{ isCompleted ? 'æ¢ç´¢å®Œæˆ' : (isRunning ? 'æ¢ç´¢ä¸­...' : 'å¼€å§‹æ¢ç´¢') }}</button>
                    <button class="secondary" @click="resetExploration" :disabled="isRunning" style="margin-left:8px;">é‡æ–°å¼€å§‹</button>
                </div>

                <ExplorationLog :entries="logEntries" />

                <div v-if="isCompleted && locationId==='cave'" style="margin-top:12px;text-align:center;background:rgba(255,215,0,0.12);padding:12px;border-radius:10px;">
                    <div style="font-size:2rem;">ğŸ’</div>
                    <h3>æ­å–œï¼ä½ æ‰¾åˆ°äº†æœ€ç»ˆå®è—ï¼</h3>
                </div>
            </div>
        </div>
    `,
    setup(props) {
        const explorer = createLocationExplorer(props.locationId);

        const location = {
            library: { name: "å¤è€å›¾ä¹¦é¦†", icon: "ğŸ“š", description: "åœ¨å°˜å°çš„ä¹¦ç±ä¸­å¯»æ‰¾å®è—çº¿ç´¢" },
            temple: { name: "ç¥ç§˜ç¥åº™", icon: "ğŸ›ï¸", description: "è§£å¼€å¤è€è°œé¢˜ï¼Œå¯»æ‰¾å®è—çº¿ç´¢" },
            forest: { name: "è¿·é›¾æ£®æ—", icon: "ğŸŒ²", description: "ç©¿è¶Šå±é™©åœ°å¸¦ï¼Œå¯»æ‰¾éšè—çš„è·¯å¾„" },
            cave: { name: "éšè—æ´ç©´", icon: "ğŸ•³ï¸", description: "æ·±å…¥åœ°ä¸‹æ´ç©´ï¼Œå¯»æ‰¾æœ€ç»ˆå®è—" }
        };

        const steps = {
            library: [
                { title: "æœç´¢ä¹¦æ¶", description: "åœ¨å¤è€çš„ä¹¦æ¶ä¸Šå¯»æ‰¾çº¿ç´¢..." },
                { title: "è§£è¯»å¤ç±", description: "ç ´è¯‘å¤è€æ–‡å­—..." },
                { title: "æ‰¾åˆ°åœ°å›¾", description: "å‘ç°éšè—çš„å®è—åœ°å›¾..." }
            ],
            temple: [
                { title: "è¿›å…¥ç¥åº™", description: "å¯»æ‰¾ç¥åº™å…¥å£..." },
                { title: "è§£å¼€è°œé¢˜", description: "ç ´è§£å¤è€æœºå…³..." },
                { title: "è·å¾—é’¥åŒ™", description: "æ‰¾åˆ°ç¥åº™æ·±å¤„çš„é’¥åŒ™..." }
            ],
            forest: [
                { title: "è¿›å…¥æ£®æ—", description: "ç©¿è¶Šæµ“å¯†çš„è¿·é›¾..." },
                { title: "å¯»æ‰¾è·¯å¾„", description: "åœ¨è¿·é›¾ä¸­å¯»æ‰¾æ­£ç¡®æ–¹å‘..." },
                { title: "å‘ç°æ ‡è®°", description: "æ‰¾åˆ°å¤è€çš„æŒ‡å¼•æ ‡è®°..." }
            ],
            cave: [
                { title: "è¿›å…¥æ´ç©´", description: "æ·±å…¥é»‘æš—çš„æ´ç©´..." },
                { title: "ç©¿è¶Šé€šé“", description: "åœ¨è¿·å®«èˆ¬çš„é€šé“ä¸­å‰è¿›..." },
                { title: "å‘ç°å®è—", description: "æ‰¾åˆ°ä¼ è¯´ä¸­çš„å®è—..." }
            ]
        };

        return {
            ...explorer,
            location: location[props.locationId],
            steps: steps[props.locationId],
            locationId: props.locationId
        };
    },
    components: { ProgressBar, StepItem, ExplorationLog }
};

const UserProfile = {
    template: `
        <div class="user-profile">
            <h2>ç”¨æˆ·ä¿¡æ¯</h2>
            <div v-if="gameState.state.currentUser" style="margin-top:8px;">
                <h3>å½“å‰ç”¨æˆ·: {{ gameState.state.currentUser.name }}</h3>
                <p>ç­‰çº§: {{ gameState.state.currentUser.level }}</p>
                <p>åŠ å…¥æ—¶é—´: {{ new Date(gameState.state.currentUser.joinDate).toLocaleDateString() }}</p>
                <div style="margin-top:8px;">
                    <button class="secondary" @click="logout">é€€å‡ºç™»å½•</button>
                </div>
            </div>

            <div v-if="gameState.state.currentUser" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:12px;">
                <div style="background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;text-align:center;">
                    <div style="font-size:0.9rem;">å®Œæˆåœ°ç‚¹</div>
                    <div style="font-weight:700;font-size:1.4rem;">{{ completed }}/4</div>
                </div>
                <div style="background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;text-align:center;">
                    <div style="font-size:0.9rem;">æ€»è¿›åº¦</div>
                    <div style="font-weight:700;font-size:1.4rem;">{{ Math.round(totalProgress) }}%</div>
                </div>
                <div style="background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;text-align:center;">
                    <div style="font-size:0.9rem;">æ€»åˆ†</div>
                    <div style="font-weight:700;font-size:1.4rem;">{{ gameState.state.currentUser.totalScore || 0 }}</div>
                </div>
            </div>

            <div v-if="gameState.state.currentUser" style="margin-top:12px;">
                <h3>åœ°ç‚¹è¿›åº¦</h3>
                <div v-for="(loc,key) in progress" :key="key" style="display:flex;align-items:center;gap:10px;padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;margin-top:8px;">
                    <div style="font-weight:700;min-width:80px;">{{ names[key] }}</div>
                    <div style="flex:1;height:10px;background:rgba(255,255,255,0.12);border-radius:6px;overflow:hidden;">
                        <div :style="{width: (loc.progress||0) + '%', height:'100%', background:'linear-gradient(90deg,#ff8a00,#e52e71)'}"></div>
                    </div>
                    <div style="min-width:40px;text-align:right;">{{ Math.round(loc.progress||0) }}%</div>
                </div>
            </div>
        </div>
    `,
    setup() {
        const logout = () => { gameState.logoutUser(); };
        const progress = computed(() => gameState.state.currentUser ? gameState.state.currentUser.progress : {});
        const completed = computed(() => {
            if (!gameState.state.currentUser) return 0;
            return Object.values(gameState.state.currentUser.progress).filter(p => p.completed).length;
        });
        const totalProgress = computed(() => {
            if (!gameState.state.currentUser) return 0;
            const sum = Object.values(gameState.state.currentUser.progress).reduce((s,p)=>s+(p.progress||0),0);
            return sum / 4;
        });
        const names = { library:'å¤è€å›¾ä¹¦é¦†', temple:'ç¥ç§˜ç¥åº™', forest:'è¿·é›¾æ£®æ—', cave:'éšè—æ´ç©´' };

        return { gameState, logout, progress, completed, totalProgress, names };
    }
};

const RankingPage = {
    template: `
        <div class="ranking-page">
            <h2>æ’è¡Œæ¦œ</h2>
            <p>çœ‹çœ‹è°æ˜¯æœ€å‰å®³çš„å®è—çŒäººï¼</p>
            <table class="ranking-table">
                <thead><tr><th>æ’å</th><th>ç©å®¶</th><th>ç­‰çº§</th><th>å®Œæˆåœ°ç‚¹</th><th>æ€»åˆ†</th><th>æœ€åæ´»è·ƒ</th></tr></thead>
                <tbody>
                    <tr v-for="user in rankings" :key="user.id" :class="{ 'current-user-highlight': isCurrent(user) }">
                        <td><span class="rank-badge">{{ user.rank }}</span></td>
                        <td>{{ user.name }}</td>
                        <td>{{ user.level }}</td>
                        <td>{{ Object.values(user.progress).filter(p=>p.completed).length }}/4</td>
                        <td>{{ user.totalScore || 0 }}</td>
                        <td>{{ user.lastActive ? new Date(user.lastActive).toLocaleDateString() : '-' }}</td>
                    </tr>
                </tbody>
            </table>
            <div v-if="rankings.length===0" style="text-align:center;margin-top:12px;">æš‚æ— æ’è¡Œæ¦œæ•°æ®</div>
        </div>
    `,
    setup() {
        const rankings = gameState.getRankings;
        const isCurrent = (u) => gameState.state.currentUser && u.id === gameState.state.currentUser.id;
        return { rankings, isCurrent };
    }
};

// ---------------- ä¸»åº”ç”¨ ----------------
const App = {
    template: `
    <div class="container">
        <header>
            <h1>å¯»å®æ¸¸æˆ</h1>
            <p class="subtitle">æ‰“å¼€é¡µé¢åå…ˆæ³¨å†Œæˆ–ç™»å½•ï¼Œç„¶åå¼€å§‹æ¢ç´¢ï¼</p>
        </header>

        <LoginPage v-if="currentView === 'login'" @switch-to-register="switchToRegister" />
        <RegisterPage v-else-if="currentView === 'register'" @switch-to-login="switchToLogin" />

        <template v-else-if="gameState.state.currentUser">
            <div class="nav-tabs">
                <div class="nav-tab" :class="{active: currentView==='panorama'}" @click="setView('panorama')">å…¨æ™¯</div>
                <div class="nav-tab" :class="{active: currentView==='profile'}" @click="setView('profile')">ç”¨æˆ·ä¿¡æ¯</div>
                <div class="nav-tab" :class="{active: currentView==='ranking'}" @click="setView('ranking')">æ’è¡Œæ¦œ</div>
            </div>

            <PanoramaPage v-if="currentView==='panorama'" @select-location="goToLocation" />
            <LocationPage v-else-if="currentView==='location'" :location-id="selectedLocation" @back="toPanorama" />
            <UserProfile v-else-if="currentView==='profile'" />
            <RankingPage v-else-if="currentView==='ranking'" />
        </template>

        <div class="music-control" @click="toggleMusic" title="éŸ³ä¹å¼€å…³"><span>{{ musicEnabled ? 'ğŸ”Š' : 'ğŸ”‡' }}</span></div>
    </div>
    `,
    components: { LoginPage, RegisterPage, PanoramaPage, LocationPage, UserProfile, RankingPage },
    setup() {
        const selectedLocation = ref(null);
        const musicEnabled = ref(gameState.state.musicEnabled || false);
        const currentAudioElement = ref(null);

        // ä½¿ç”¨è®¡ç®—å±æ€§æ¥å“åº”å¼åœ°è·å–å½“å‰é¡µé¢
        const currentView = computed(() => {
            if (!gameState.state.currentUser) {
                return gameState.state.currentPage || 'login';
            }
            return gameState.state.currentPage || 'panorama';
        });
        
        // æ ¹æ®å½“å‰é¡µé¢åˆ‡æ¢èƒŒæ™¯éŸ³ä¹
        const updateBackgroundMusic = () => {
            // åœæ­¢æ‰€æœ‰éŸ³ä¹
            const allAudioElements = [
                document.getElementById('homeMusic'),
                document.getElementById('libraryMusic'),
                document.getElementById('templeMusic'),
                document.getElementById('forestMusic'),
                document.getElementById('caveMusic')
            ];
            
            allAudioElements.forEach(audio => {
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                }
            });
            
            // æ ¹æ®å½“å‰é¡µé¢é€‰æ‹©å¯¹åº”çš„éŸ³ä¹
            let audioId = 'homeMusic'; // é»˜è®¤é¦–é¡µéŸ³ä¹
            
            if (currentView.value === 'location' && selectedLocation.value) {
                // æ ¹æ®åœ°ç‚¹é€‰æ‹©éŸ³ä¹
                audioId = selectedLocation.value + 'Music';
            }
            // å…¶ä»–é¡µé¢ï¼ˆlogin, register, panorama, profile, rankingï¼‰éƒ½ä½¿ç”¨é¦–é¡µéŸ³ä¹
            
            currentAudioElement.value = document.getElementById(audioId);
            
            if (currentAudioElement.value && musicEnabled.value) {
                currentAudioElement.value.volume = 0.5;
                currentAudioElement.value.play().catch(e => {
                    console.log('éŸ³ä¹æ’­æ”¾å¤±è´¥:', e);
                });
            }
        };
        
        const setView = (v) => { 
            gameState.setCurrentPage(v);
            updateBackgroundMusic();
        };
        
        const goToLocation = (locId) => { 
            selectedLocation.value = locId; 
            gameState.setCurrentPage('location');
            updateBackgroundMusic();
        };
        
        const toPanorama = () => { 
            selectedLocation.value = null; 
            gameState.setCurrentPage('panorama');
            updateBackgroundMusic();
        };

        const switchToRegister = () => { 
            gameState.setCurrentPage('register');
            updateBackgroundMusic();
        };
        
        const switchToLogin = () => { 
            gameState.setCurrentPage('login');
            updateBackgroundMusic();
        };

        const toggleMusic = () => {
            musicEnabled.value = !musicEnabled.value;
            gameState.toggleMusic();
            
            // æ§åˆ¶éŸ³ä¹æ’­æ”¾
            if (currentAudioElement.value) {
                if (musicEnabled.value) {
                    currentAudioElement.value.play().catch(e => {
                        console.log('éŸ³ä¹æ’­æ”¾å¤±è´¥:', e);
                    });
                } else {
                    currentAudioElement.value.pause();
                }
            }
        };

        onMounted(() => {
            // ä¸å†åŠ è½½ä»»ä½•ä¿å­˜çš„çŠ¶æ€
            
            // åˆå§‹åŒ–æ‰€æœ‰éŸ³é¢‘å…ƒç´ 
            const allAudioElements = [
                document.getElementById('homeMusic'),
                document.getElementById('libraryMusic'),
                document.getElementById('templeMusic'),
                document.getElementById('forestMusic'),
                document.getElementById('caveMusic')
            ];
            
            allAudioElements.forEach(audio => {
                if (audio) {
                    audio.volume = 0.5;
                }
            });
            
            // è®¾ç½®åˆå§‹éŸ³ä¹
            updateBackgroundMusic();
        });

        return { 
            currentView,
            selectedLocation, 
            setView, 
            goToLocation, 
            toPanorama, 
            switchToRegister, 
            switchToLogin, 
            musicEnabled, 
            toggleMusic, 
            gameState 
        };
    }
};

createApp(App).mount('#app');
</script>
</body>
</html>